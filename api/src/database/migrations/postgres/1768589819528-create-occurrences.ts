import { MigrationInterface, QueryRunner } from "typeorm";

export class CreateOccurrences1768589819528 implements MigrationInterface {
    name = 'CreateOccurrences1768589819528'

    public async up(queryRunner: QueryRunner): Promise<void> {
        // 1. CRIA AS NOVAS TABELAS (OCORRENCIA)
        await queryRunner.query(`CREATE TABLE "TB_TIPO_OCORRENCIA" ("CO_SEQ_TIPO_OCORRENCIA" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "CO_ID_TIPO_OCORRENCIA" character varying NOT NULL, "DS_TIPO_OCORRENCIA" character varying(100) NOT NULL, "ST_ATIVO" character varying(1) NOT NULL, CONSTRAINT "UQ_b7f8252fe1a91a30765cfb297f2" UNIQUE ("CO_ID_TIPO_OCORRENCIA"), CONSTRAINT "PK_92631b2b0d92935ab91244063e8" PRIMARY KEY ("CO_SEQ_TIPO_OCORRENCIA"))`);
        await queryRunner.query(`CREATE TABLE "TB_TIPO_DOCUMENTO" ("CO_SEQ_TIPO_DOCUMENTO" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "CO_ID_TIPO_DOCUMENTO" character varying NOT NULL, "DS_TIPO_DOCUMENTO" character varying(100) NOT NULL, "ST_ATIVO" character varying(1) NOT NULL, CONSTRAINT "UQ_0d847fd7b5152dc20f56ddcf53b" UNIQUE ("CO_ID_TIPO_DOCUMENTO"), CONSTRAINT "PK_dc447968b447140e4b029bab2e9" PRIMARY KEY ("CO_SEQ_TIPO_DOCUMENTO"))`);
        await queryRunner.query(`CREATE TABLE "TB_OCORRENCIA_ANEXO" ("CO_SEQ_OCORRENCIA_ANEXO" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "NO_NOME_ARQUIVO" character varying(255) NOT NULL, "DS_TIPO_MIME" character varying(100) NOT NULL, "NU_TAMANHO_ARQUIVO" bigint NOT NULL, "DS_CAMINHO_ARQUIVO" character varying(500) NOT NULL, "DT_CRIACAO" TIMESTAMP NOT NULL DEFAULT now(), "CO_SEQ_OCORRENCIA" bigint NOT NULL, CONSTRAINT "PK_795a6cc95f052a34ba4d61f90bf" PRIMARY KEY ("CO_SEQ_OCORRENCIA_ANEXO"))`);
        await queryRunner.query(`CREATE TABLE "TB_OCORRENCIA" ("CO_SEQ_OCORRENCIA" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, "NU_CNPJ_FARMACIA" character varying(14) NOT NULL, "NU_OCORRENCIA" character varying(20) NOT NULL, "DS_OCORRENCIA" character varying(100) NOT NULL, "ST_ATIVO" character varying(1) NOT NULL, "DT_CRIACAO" TIMESTAMP NOT NULL, "DT_ATUALIZACAO" TIMESTAMP DEFAULT now(), "DT_ABRANGENCIA_INICIO" TIMESTAMP NOT NULL, "DT_ABRANGENCIA_FIM" TIMESTAMP, "NU_DOCUMENTO" character varying(60), "DS_TITULO" character varying(200), "DS_OBSERVACAO" text, "CO_USUARIO_RESP" bigint NOT NULL, "CO_SEQ_TIPO_OCORRENCIA" bigint, "CO_ID_TIPO_DOCUMENTO" bigint, CONSTRAINT "UQ_f0d722f000581a058de7974aabc" UNIQUE ("NU_CNPJ_FARMACIA"), CONSTRAINT "UQ_1346f6ca89a90315d16b7564b15" UNIQUE ("NU_OCORRENCIA"), CONSTRAINT "PK_696fac53dfcb29f577dedac0120" PRIMARY KEY ("CO_SEQ_OCORRENCIA"))`);
        
        // 2. CRIA AS FKs DAS NOVAS TABELAS
        await queryRunner.query(`ALTER TABLE "TB_OCORRENCIA_ANEXO" ADD CONSTRAINT "FK_24644212de473537943b0c82511" FOREIGN KEY ("CO_SEQ_OCORRENCIA") REFERENCES "TB_OCORRENCIA"("CO_SEQ_OCORRENCIA") ON DELETE CASCADE ON UPDATE NO ACTION`);
        await queryRunner.query(`ALTER TABLE "TB_OCORRENCIA" ADD CONSTRAINT "FK_051c9fd6769ee740581f08b91d5" FOREIGN KEY ("CO_SEQ_TIPO_OCORRENCIA") REFERENCES "TB_TIPO_OCORRENCIA"("CO_SEQ_TIPO_OCORRENCIA") ON DELETE NO ACTION ON UPDATE NO ACTION`);
        await queryRunner.query(`ALTER TABLE "TB_OCORRENCIA" ADD CONSTRAINT "FK_7c3f951d26b7667d1c32957f7dd" FOREIGN KEY ("CO_ID_TIPO_DOCUMENTO") REFERENCES "TB_TIPO_DOCUMENTO"("CO_SEQ_TIPO_DOCUMENTO") ON DELETE NO ACTION ON UPDATE NO ACTION`);
        
        // (REMOVIDO TUDO O QUE TOCAVA EM TB_FARMACIA_CREDENCIAMENTO)
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        // DESFAZ APENAS O QUE FOI FEITO NO UP
        await queryRunner.query(`ALTER TABLE "TB_OCORRENCIA" DROP CONSTRAINT "FK_7c3f951d26b7667d1c32957f7dd"`);
        await queryRunner.query(`ALTER TABLE "TB_OCORRENCIA" DROP CONSTRAINT "FK_051c9fd6769ee740581f08b91d5"`);
        await queryRunner.query(`ALTER TABLE "TB_OCORRENCIA_ANEXO" DROP CONSTRAINT "FK_24644212de473537943b0c82511"`);
        await queryRunner.query(`DROP TABLE "TB_OCORRENCIA"`);
        await queryRunner.query(`DROP TABLE "TB_OCORRENCIA_ANEXO"`);
        await queryRunner.query(`DROP TABLE "TB_TIPO_DOCUMENTO"`);
        await queryRunner.query(`DROP TABLE "TB_TIPO_OCORRENCIA"`);
    }

}